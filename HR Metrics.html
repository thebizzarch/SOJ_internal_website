```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Employee Work Time Analysis Dashboard</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Chart.js for visualization -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  
  <!-- PAPA Parse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  
  <style>
    /* Same style as before */
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: #f9fafb;
      margin: 0;
      padding: 20px;
    }
    
    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f3f4f6;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .dashboard-title {
      text-align: center;
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 24px;
      color: #1f2937;
    }
    
    .stats-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background-color: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .stat-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #2563eb;
      margin-bottom: 4px;
    }
    
    .stat-value.green {
      color: #059669;
    }
    
    .stat-value.purple {
      color: #7c3aed;
    }
    
    .stat-subtitle {
      font-size: 14px;
      color: #6b7280;
    }
    
    .cost-text {
      font-size: 14px;
      font-weight: 600;
      color: #059669;
      margin-top: 8px;
    }
    
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
      margin-bottom: 24px;
    }
    
    .chart-container {
      background-color: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .chart-title {
      text-align: center;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #374151;
    }
    
    .full-width-chart {
      grid-column: span 2;
    }
    
    /* Tab styling */
    .tabs {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 20px;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
      font-weight: 500;
    }
    
    .tab.active {
      border-bottom: 2px solid #2563eb;
      color: #2563eb;
      font-weight: 600;
    }
    
    .tab:hover:not(.active) {
      border-bottom: 2px solid #93c5fd;
      color: #3b82f6;
    }
    
    .employee-dashboard {
      display: none;
    }
    
    .employee-dashboard.active {
      display: block;
    }
    
    .employee-notice {
      text-align: center;
      padding: 40px;
      color: #6b7280;
      font-size: 18px;
    }
    
    .week-selector {
      background-color: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
    }
    
    .loading-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px;
      background: rgba(255,255,255,0.9);
      border: 1px solid #ddd;
      border-radius: 8px;
      z-index: 1000;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .last-updated {
      text-align: right;
      font-size: 12px;
      color: #6b7280;
      margin-top: -20px;
      margin-bottom: 10px;
    }

    /* File import */
    .file-import {
      margin-top: 10px;
      padding: 10px;
      border: 2px dashed #ddd;
      border-radius: 8px;
      text-align: center;
    }

    .file-import.active {
      border-color: #2563eb;
      background-color: rgba(37, 99, 235, 0.05);
    }

    /* Animation for refresh button */
    .spin-animation {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .stats-container,
      .charts-grid {
        grid-template-columns: 1fr;
      }
      
      .full-width-chart {
        grid-column: auto;
      }
      
      .tabs {
        flex-wrap: wrap;
      }
      
      .tab {
        flex: 1 0 auto;
        text-align: center;
        padding: 10px;
      }
    }

    canvas {
      max-width: 100%;
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <h1 class="dashboard-title">Employee Work Time Analysis</h1>
    
    <!-- Date/Week Range Selector -->
    <div class="week-selector bg-white p-4 rounded-lg shadow mb-6">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-semibold">Date/Week Range Filter</h2>
        
        <!-- Refresh button -->
        <button id="refresh-button" class="bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 transition-colors flex items-center">
          <svg id="refresh-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
          </svg>
          Refresh Data
        </button>
      </div>
      
      <div class="last-updated mb-3">
        Last updated: <span id="last-updated-time">Loading...</span>
      </div>
      
      <!-- File import option -->
      <div class="file-import mb-4" id="file-import-area">
        <p class="mb-2">Drag &amp; drop CSV file here or</p>
        <input type="file" id="csv-file-input" accept=".csv" class="hidden">
        <button id="file-select-button" class="bg-blue-500 text-white py-1 px-3 rounded hover:bg-blue-600 transition-colors">
          Select CSV File
        </button>
      </div>
      
      <div class="flex flex-wrap items-center gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">From Week:</label>
          <select id="start-week" class="border rounded p-2 w-full">
            <option value="all">All Time</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">To Week:</label>
          <select id="end-week" class="border rounded p-2 w-full">
            <option value="all">All Time</option>
          </select>
        </div>
        
        <div class="flex items-end">
          <button id="apply-filter" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition-colors">
            Apply Filter
          </button>
        </div>
        
        <div class="flex items-end">
          <button id="reset-filter" class="bg-gray-200 text-gray-800 py-2 px-4 rounded hover:bg-gray-300 transition-colors">
            Reset
          </button>
        </div>
      </div>
      
      <div id="active-filter" class="mt-3 text-sm hidden">
        <span class="font-medium">Active Filter:</span>
        <span id="filter-text" class="text-blue-600"></span>
      </div>
    </div>
    
    <!-- Employee tabs -->
    <div class="tabs">
      <div class="tab active" data-employee="all">All Employees</div>
      <div class="tab" data-employee="victoria">Victoria</div>
      <div class="tab" data-employee="kyle">Kyle</div>
      <div class="tab" data-employee="brooke">Brooke</div>
      <div class="tab" data-employee="melanie">Melanie</div>
    </div>
    
    <!-- All Employees Dashboard -->
    <div id="all-dashboard" class="employee-dashboard active">
      <!-- Summary statistics -->
      <div class="stats-container">
        <div class="stat-card">
          <h2 class="stat-title">Total Team Hours</h2>
          <p class="stat-value" id="all-total-hours">--</p>
          <p class="stat-subtitle" id="all-total-hours-subtitle">Loading...</p>
          <p class="cost-text" id="all-total-cost">--</p>
        </div>
        
        <div class="stat-card">
          <h2 class="stat-title">Most Time Spent On</h2>
          <p class="stat-value green" id="all-most-time-activity">--</p>
          <p class="stat-subtitle" id="all-most-time-hours">Loading...</p>
          <p class="cost-text" id="all-most-time-cost">--</p>
        </div>
        
        <div class="stat-card">
          <h2 class="stat-title">Team Weekly Average</h2>
          <p class="stat-value purple" id="all-weekly-average">--</p>
          <p class="stat-subtitle" id="all-weekly-average-subtitle">Loading...</p>
          <p class="cost-text" id="all-weekly-average-cost">--</p>
        </div>
      </div>
      
      <!-- Main charts -->
      <div class="charts-grid">
        <!-- Time Distribution Pie Chart -->
        <div class="chart-container">
          <h2 class="chart-title">Team Time Distribution by Category</h2>
          <div style="position: relative; height: 300px;">
            <canvas id="all-pieChart"></canvas>
          </div>
        </div>
        
        <!-- Task Breakdown Bar Chart -->
        <div class="chart-container">
          <h2 class="chart-title">Team Task Breakdown (Hours & Cost)</h2>
          <div style="position: relative; height: 300px;">
            <canvas id="all-barChart"></canvas>
          </div>
        </div>
        
        <!-- Employee Time Allocation Comparison -->
        <div class="chart-container full-width-chart">
          <h2 class="chart-title">Employee Time Allocation Comparison</h2>
          <div style="position: relative; height: 350px;">
            <canvas id="team-comparisonChart"></canvas>
          </div>
        </div>
        
        <!-- Weekly Trends Chart if we have multiple weeks -->
        <div class="chart-container full-width-chart">
          <h2 class="chart-title">Team Weekly Trends</h2>
          <div style="position: relative; height: 350px;" id="all-timeLineChart-container">
            <canvas id="all-timeLineChart"></canvas>
          </div>
          <div class="employee-notice" id="all-no-trend-data" style="display: none;">
            Weekly trend data not available
          </div>
        </div>
      </div>
    </div>
    
    <!-- Victoria's Dashboard -->
    <div id="victoria-dashboard" class="employee-dashboard">
      <!-- Summary statistics -->
      <div class="stats-container">
        <div class="stat-card">
          <h2 class="stat-title">Total Hours</h2>
          <p class="stat-value" id="victoria-total-hours">--</p>
          <p class="stat-subtitle" id="victoria-total-hours-subtitle">Loading...</p>
          <p class="cost-text" id="victoria-total-cost">--</p>
        </div>
        
        <div class="stat-card">
          <h2 class="stat-title">Most Time Spent On</h2>
          <p class="stat-value green" id="victoria-most-time-activity">--</p>
          <p class="stat-subtitle" id="victoria-most-time-hours">Loading...</p>
          <p class="cost-text" id="victoria-most-time-cost">--</p>
        </div>
        
        <div class="stat-card">
          <h2 class="stat-title">Weekly Average</h2>
          <p class="stat-value purple" id="victoria-weekly-average">--</p>
          <p class="stat-subtitle" id="victoria-weekly-average-subtitle">Loading...</p>
          <p class="cost-text" id="victoria-weekly-average-cost">--</p>
        </div>
      </div>
      
      <!-- Main charts -->
      <div class="charts-grid">
        <!-- Time Distribution Pie Chart -->
        <div class="chart-container">
          <h2 class="chart-title">Time Distribution by Category</h2>
          <div style="position: relative; height: 300px;">
            <canvas id="victoria-pieChart"></canvas>
          </div>
        </div>
        
        <!-- Task Breakdown Bar Chart -->
        <div class="chart-container">
          <h2 class="chart-title">Task Breakdown (Hours & Cost)</h2>
          <div style="position: relative; height: 300px;">
            <canvas id="victoria-barChart"></canvas>
          </div>
        </div>
        
        <!-- Weekly Time Trends -->
        <div class="chart-container full-width-chart">
          <h2 class="chart-title">Weekly Time Trends (Hours)</h2>
          <div style="position: relative; height: 350px;" id="victoria-timeLineChart-container">
            <canvas id="victoria-timeLineChart"></canvas>
          </div>
          <div class="employee-notice" id="victoria-no-trend-data" style="display: none;">
            Weekly trend data not available
          </div>
        </div>
      </div>
    </div>
    
    <!-- Kyle's Dashboard -->
    <div id="kyle-dashboard" class="employee-dashboard">
      <!-- Summary statistics -->
      <div class="stats-container">
        <div class="stat-card">
          <h2 class="stat-title">Total Hours</h2>
          <p class="stat-value" id="kyle-total-hours">--</p>
          <p class="stat-subtitle" id="kyle-total-hours-subtitle">Loading...</p>
          <p class="cost-text" id="kyle-total-cost">--</p>
        </div>
        
        <div class="stat-card">
          <h2 class="stat-title">Most Time Spent On</h2>
          <p class="stat-value green" id="kyle-most-time-activity">--</p>
          <p class="stat-subtitle" id="kyle-most-time-hours">Loading...</p>
          <p class="cost-text" id="kyle-most-time-cost">--</p>
        </div>
        
        <div class="stat-card">
          <h2 class="stat-title">Weekly Average</h2>
          <p class="stat-value purple" id="kyle-weekly-average">--</p>
          <p class="stat-subtitle" id="kyle-weekly-average-subtitle">Loading...</p>
          <p class="cost-text" id="kyle-weekly-average-cost">--</p>
        </div>
      </div>
      
      <!-- Main charts -->
      <div class="charts-grid">
        <!-- Time Distribution Pie Chart -->
        <div class="chart-container">
          <h2 class="chart-title">Time Distribution by Category</h2>
          <div style="position: relative; height: 300px;">
            <canvas id="kyle-pieChart"></canvas>
          </div>
        </div>
        
        <!-- Task Breakdown Bar Chart -->
        <div class="chart-container">
          <h2 class="chart-title">Task Breakdown (Hours & Cost)</h2>
          <div style="position: relative; height: 300px;">
            <canvas id="kyle-barChart"></canvas>
          </div>
        </div>
        
        <!-- Weekly Time Trends -->
        <div class="chart-container full-width-chart">
          <h2 class="chart-title">Weekly Time Trends</h2>
          <div style="position: relative; height: 350px; display: none;" id="kyle-timeLineChart-container">
            <canvas id="kyle-timeLineChart"></canvas>
          </div>
          <div class="employee-notice" id="kyle-no-trend-data">
            Weekly trend data not available
          </div>
        </div>
      </div>
    </div>
    
    <!-- Brooke's Dashboard -->
    <div id="brooke-dashboard" class="employee-dashboard">
      <!-- Summary statistics -->
      <div class="stats-container">
        <div class="stat-card">
          <h2 class="stat-title">Total Hours</h2>
          <p class="stat-value" id="brooke-total-hours">--</p>
          <p class="stat-subtitle" id="brooke-total-hours-subtitle">Loading...</p>
          <p class="cost-text" id="brooke-total-cost">--</p>
        </div>
        
        <div class="stat-card">
          <h2 class="stat-title">Most Time Spent On</h2>
          <p class="stat-value green" id="brooke-most-time-activity">--</p>
          <p class="stat-subtitle" id="brooke-most-time-hours">Loading...</p>
          <p class="cost-text" id="brooke-most-time-cost">--</p>
        </div>
        
        <div class="stat-card">
          <h2 class="stat-title">Weekly Average</h2>
          <p class="stat-value purple" id="brooke-weekly-average">--</p>
          <p class="stat-subtitle" id="brooke-weekly-average-subtitle">Loading...</p>
          <p class="cost-text" id="brooke-weekly-average-cost">--</p>
        </div>
      </div>
      
      <!-- Main charts -->
      <div class="charts-grid">
        <!-- Time Distribution Pie Chart -->
        <div class="chart-container">
          <h2 class="chart-title">Time Distribution by Category</h2>
          <div style="position: relative; height: 300px;">
            <canvas id="brooke-pieChart"></canvas>
          </div>
        </div>
        
        <!-- Task Breakdown Bar Chart -->
        <div class="chart-container">
          <h2 class="chart-title">Task Breakdown (Hours & Cost)</h2>
          <div style="position: relative; height: 300px;">
            <canvas id="brooke-barChart"></canvas>
          </div>
        </div>
        
        <!-- Weekly Time Trends -->
        <div class="chart-container full-width-chart">
          <h2 class="chart-title">Weekly Time Trends (Hours)</h2>
          <div style="position: relative; height: 350px;" id="brooke-timeLineChart-container">
            <canvas id="brooke-timeLineChart"></canvas>
          </div>
          <div class="employee-notice" id="brooke-no-trend-data" style="display: none;">
            Weekly trend data not available
          </div>
        </div>
      </div>
    </div>
    
    <!-- Melanie's Dashboard -->
    <div id="melanie-dashboard" class="employee-dashboard">
      <!-- Summary statistics -->
      <div class="stats-container">
        <div class="stat-card">
          <h2 class="stat-title">Total Hours</h2>
          <p class="stat-value" id="melanie-total-hours">--</p>
          <p class="stat-subtitle" id="melanie-total-hours-subtitle">Loading...</p>
          <p class="cost-text" id="melanie-total-cost">--</p>
        </div>
        
        <div class="stat-card">
          <h2 class="stat-title">Most Time Spent On</h2>
          <p class="stat-value green" id="melanie-most-time-activity">--</p>
          <p class="stat-subtitle" id="melanie-most-time-hours">Loading...</p>
          <p class="cost-text" id="melanie-most-time-cost">--</p>
        </div>
        
        <div class="stat-card">
          <h2 class="stat-title">Weekly Average</h2>
          <p class="stat-value purple" id="melanie-weekly-average">--</p>
          <p class="stat-subtitle" id="melanie-weekly-average-subtitle">Loading...</p>
          <p class="cost-text" id="melanie-weekly-average-cost">--</p>
        </div>
      </div>
      
      <!-- Main charts -->
      <div class="charts-grid">
        <!-- Time Distribution Pie Chart -->
        <div class="chart-container">
          <h2 class="chart-title">Time Distribution by Category</h2>
          <div style="position: relative; height: 300px;">
            <canvas id="melanie-pieChart"></canvas>
          </div>
        </div>
        
        <!-- Task Breakdown Bar Chart -->
        <div class="chart-container">
          <h2 class="chart-title">Task Breakdown (Hours & Cost)</h2>
          <div style="position: relative; height: 300px;">
            <canvas id="melanie-barChart"></canvas>
          </div>
        </div>
        
        <!-- Weekly Time Trends -->
        <div class="chart-container full-width-chart">
          <h2 class="chart-title">Weekly Time Trends</h2>
          <div style="position: relative; height: 350px; display: none;" id="melanie-timeLineChart-container">
            <canvas id="melanie-timeLineChart"></canvas>
          </div>
          <div class="employee-notice" id="melanie-no-trend-data">
            Weekly trend data not available
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Loading message element -->
  <div id="loading-message" class="loading-message">Loading dashboard data...</div>
  
  <script>
    // ======= CONFIGURATION =======
    const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTqE6c8k9tzjkfiiWEIa9v-OV3eGI9xOSwbJqWx1LzCkXPX1dSnwYMPjQZRMteZRVvjZ1BGfq9Dxaql/pub?gid=0&single=true&output=csv';
    
    // Employee hourly rates configuration
    const EMPLOYEE_HOURLY_RATES = {
      victoria: 22.50,  // Adjust these values as needed
      kyle: 18.75,
      brooke: 20.25,
      melanie: 24.00,
      default: 16.50   // Default rate if employee not specified
    };

    // Helper function to get hourly rate for a specific employee
    function getHourlyRate(employeeName) {
      if (!employeeName) return EMPLOYEE_HOURLY_RATES.default;
      // Convert to lowercase and remove any email domain if present
      const normalizedName = employeeName.toLowerCase().split('@')[0];
      return EMPLOYEE_HOURLY_RATES[normalizedName] || EMPLOYEE_HOURLY_RATES.default;
    }
    // ============================
    
    // Constants
    const COLORS = [
      'rgba(0, 136, 254, 0.8)',   // #0088FE - blue
      'rgba(0, 196, 159, 0.8)',   // #00C49F - teal
      'rgba(255, 187, 40, 0.8)',  // #FFBB28 - yellow
      'rgba(255, 128, 66, 0.8)',  // #FF8042 - orange
      'rgba(136, 132, 216, 0.8)', // #8884d8 - purple
      'rgba(130, 202, 157, 0.8)', // #82ca9d - green
      'rgba(249, 99, 50, 0.8)',   // #F96332 - red-orange
      'rgba(87, 117, 144, 0.8)',  // #577590 - slate blue
      'rgba(249, 132, 74, 0.8)',  // #F9844A - peach
      'rgba(100, 204, 197, 0.8)'  // #64CCC5 - turquoise
    ];
    
    const BORDER_COLORS = [
      'rgb(0, 136, 254)',         // #0088FE
      'rgb(0, 196, 159)',         // #00C49F
      'rgb(255, 187, 40)',        // #FFBB28
      'rgb(255, 128, 66)',        // #FF8042
      'rgb(136, 132, 216)',       // #8884d8
      'rgb(130, 202, 157)',       // #82ca9d
      'rgb(249, 99, 50)',         // #F96332
      'rgb(87, 117, 144)',        // #577590
      'rgb(249, 132, 74)',        // #F9844A
      'rgb(100, 204, 197)'        // #64CCC5
    ];
    
    // Global variables
    let employeesData = [];
    let filteredEmployeesData = [];
    let activeStartWeek = 'all';
    let activeEndWeek = 'all';
    let lastUpdated = null;
    
    // Store chart instances
    const charts = {
      all: { pieChart: null, barChart: null, timeLineChart: null, comparisonChart: null },
      victoria: { pieChart: null, barChart: null, timeLineChart: null },
      kyle: { pieChart: null, barChart: null, timeLineChart: null },
      brooke: { pieChart: null, barChart: null, timeLineChart: null },
      melanie: { pieChart: null, barChart: null, timeLineChart: null }
    };
    
    // Group categories by type
    const categoriesByType = {
      'Business Development': ['BD - Research', 'BD - Emailing', 'BD - Calls'],
      'Congress': ['Congress - Research', 'Congress - Emailing', 'Congress - Calls'],
      'Social Media': ['Social Management', 'Social Content - Research', 'Social Content - Scripting', 
                      'Social Content - Recording', 'Social Content - Video Editing', 'Social Content - Graphic Design',
                      'Influencer Outreach'],
      'Newsletter': ['Newsletter - Writing/Editing', 'Newsletter - Operations'],
      'Miscellaneous': ['Misc. Content', 'Misc. Research'],
      'Meetings and Admin': ['Internal Meetings', 'Admin']
    };
    
    // Function to fetch data from Google Sheets - now with multiple methods to bypass CORS
    async function fetchEmployeeData() {
      try {
        // Show loading indicator
        const loadingMessage = document.getElementById('loading-message');
        loadingMessage.style.display = 'block';
        loadingMessage.textContent = 'Loading data from Google Sheets...';
        
        // Start refresh icon animation
        const refreshIcon = document.getElementById('refresh-icon');
        refreshIcon.classList.add('spin-animation');
        
        let csvText = null;
        
        try {
          // Try direct fetch - may fail due to CORS
          const response = await fetch(SPREADSHEET_URL);
          if (response.ok) {
            csvText = await response.text();
          }
        } catch (directFetchError) {
          console.log('Direct fetch failed, trying alternate methods...', directFetchError);
        }
        
        // If direct fetch failed, try with a CORS proxy
        if (!csvText) {
          try {
            const proxyUrl = 'https://cors-anywhere.herokuapp.com/' + SPREADSHEET_URL;
            const proxyResponse = await fetch(proxyUrl, {
              headers: {
                'Origin': window.location.origin,
                'X-Requested-With': 'XMLHttpRequest'
              }
            });
            
            if (proxyResponse.ok) {
              csvText = await proxyResponse.text();
            }
          } catch (proxyError) {
            console.log('CORS proxy fetch failed...', proxyError);
          }
        }
        
        // If both methods failed, show message to upload CSV
        if (!csvText) {
          loadingMessage.innerHTML = 
            'Could not load data from Google Sheets due to browser security restrictions.<br><br>' +
            'Please use the file upload option to load your CSV file.';
          refreshIcon.classList.remove('spin-animation');
          return [];
        }
        
        // Parse CSV using Papa Parse
        const parseResult = Papa.parse(csvText, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true
        });
        
        if (parseResult.errors.length > 0) {
          console.warn('CSV parsing had errors:', parseResult.errors);
        }
        
        if (parseResult.data.length === 0) {
          throw new Error('No data found in the CSV');
        }
        
        // Update last updated time
        lastUpdated = new Date();
        document.getElementById('last-updated-time').textContent = lastUpdated.toLocaleString();
        
        // Update week range dropdowns
        updateWeekRangeOptions(parseResult.data);
        
        // Stop refresh icon animation
        refreshIcon.classList.remove('spin-animation');
        
        // Hide loading message
        loadingMessage.style.display = 'none';
        
        return parseResult.data;
      } catch (error) {
        console.error('Error fetching or parsing data:', error);
        document.getElementById('loading-message').innerHTML = 
          `Error: ${error.message} <br><br>Please try using the file upload option instead.`;
        document.getElementById('refresh-icon').classList.remove('spin-animation');
        return [];
      }
    }
    
    // Process file upload
    function handleFileUpload(file) {
      const loadingMessage = document.getElementById('loading-message');
      loadingMessage.style.display = 'block';
      loadingMessage.textContent = 'Processing CSV file...';
      
      const refreshIcon = document.getElementById('refresh-icon');
      refreshIcon.classList.add('spin-animation');
      
      // Use Papa Parse to parse the CSV
      Papa.parse(file, {
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: function(results) {
          if (results.errors.length > 0) {
            console.warn('CSV parsing had errors:', results.errors);
          }
          
          if (results.data.length === 0) {
            loadingMessage.textContent = 'No data found in the CSV file.';
            refreshIcon.classList.remove('spin-animation');
            return;
          }
          
          // Update global data
          employeesData = results.data;
          filteredEmployeesData = [...employeesData];
          
          // Update last updated time
          lastUpdated = new Date();
          document.getElementById('last-updated-time').textContent = lastUpdated.toLocaleString();
          
          // Update week range dropdowns
          updateWeekRangeOptions(results.data);
          
          // Update all charts
          updateAllEmployeeCharts();
          
          // Hide loading message
          loadingMessage.style.display = 'none';
          refreshIcon.classList.remove('spin-animation');
        },
        error: function(error) {
          console.error('Error parsing CSV:', error);
          loadingMessage.textContent = 'Error parsing CSV file. Please check the file format.';
          refreshIcon.classList.remove('spin-animation');
        }
      });
    }
    
    // Function to update week range dropdown options
    function updateWeekRangeOptions(data) {
      const weeks = [...new Set(data.map(row => row['Week Range']))].sort((a, b) => {
        return parseInt(a.replace('2025W', '')) - parseInt(b.replace('2025W', ''));
      });
      
      const startWeekSelect = document.getElementById('start-week');
      const endWeekSelect = document.getElementById('end-week');
      
      // Save current selections
      const currentStartWeek = startWeekSelect.value;
      const currentEndWeek = endWeekSelect.value;
      
      // Clear existing options except "All Time"
      while (startWeekSelect.options.length > 1) {
        startWeekSelect.remove(1);
      }
      
      while (endWeekSelect.options.length > 1) {
        endWeekSelect.remove(1);
      }
      
      // Add options for each week
      weeks.forEach(week => {
        const startOption = document.createElement('option');
        startOption.value = week;
        startOption.textContent = `Week ${week.replace('2025W', '')}`;
        startWeekSelect.appendChild(startOption);
        
        const endOption = document.createElement('option');
        endOption.value = week;
        endOption.textContent = `Week ${week.replace('2025W', '')}`;
        endWeekSelect.appendChild(endOption);
      });
      
      // Restore selections if they exist in the new options
      if (weeks.includes(currentStartWeek)) {
        startWeekSelect.value = currentStartWeek;
      }
      
      if (weeks.includes(currentEndWeek)) {
        endWeekSelect.value = currentEndWeek;
      } else if (weeks.length > 0) {
        // Default to the latest week for end week
        endWeekSelect.value = weeks[weeks.length - 1];
      }
    }
    
    // Function to filter employee data by week range
    function filterDataByWeekRange(data, startWeek, endWeek) {
      if (startWeek === 'all' && endWeek === 'all') {
        return [...data];
      }
      
      return data.filter(row => {
        const weekRange = row['Week Range'];
        
        // If only start week is specified
        if (startWeek !== 'all' && endWeek === 'all') {
          const weekNum = parseInt(weekRange.replace('2025W', ''));
          const startWeekNum = parseInt(startWeek.replace('2025W', ''));
          return weekNum >= startWeekNum;
        }
        
        // If only end week is specified
        if (startWeek === 'all' && endWeek !== 'all') {
          const weekNum = parseInt(weekRange.replace('2025W', ''));
          const endWeekNum = parseInt(endWeek.replace('2025W', ''));
          return weekNum <= endWeekNum;
        }
        
        // If both are specified
        const weekNum = parseInt(weekRange.replace('2025W', ''));
        const startWeekNum = parseInt(startWeek.replace('2025W', ''));
        const endWeekNum = parseInt(endWeek.replace('2025W', ''));
        
        return weekNum >= startWeekNum && weekNum <= endWeekNum;
      });
    }
    
    // Function to update all employee charts with filtered data
    function updateAllEmployeeCharts() {
      // Initialize the team dashboard first
      initializeTeamDashboard();
      
      // Then initialize individual employee dashboards
      initializeEmployeeCharts('victoria');
      initializeEmployeeCharts('kyle');
      initializeEmployeeCharts('brooke');
      initializeEmployeeCharts('melanie');
      
      // Update filter display
      const activeFilter = document.getElementById('active-filter');
      const filterText = document.getElementById('filter-text');
      
      if (activeStartWeek === 'all' && activeEndWeek === 'all') {
        activeFilter.classList.add('hidden');
      } else {
        activeFilter.classList.remove('hidden');
        let filterString = '';
        
        if (activeStartWeek === 'all') {
          filterString = `Up to Week ${activeEndWeek.replace('2025W', '')}`;
        } else if (activeEndWeek === 'all') {
          filterString = `From Week ${activeStartWeek.replace('2025W', '')} onwards`;
        } else {
          filterString = `Week ${activeStartWeek.replace('2025W', '')} to Week ${activeEndWeek.replace('2025W', '')}`;
        }
        
        filterText.textContent = filterString;
      }
    }
    
    // Function to validate the week selection
    function validateWeekSelection(startWeek, endWeek) {
      if (startWeek === 'all' || endWeek === 'all') {
        return true;
      }
      
      const startWeekNum = parseInt(startWeek.replace('2025W', ''));
      const endWeekNum = parseInt(endWeek.replace('2025W', ''));
      
      return startWeekNum <= endWeekNum;
    }
    
    // Function to initialize the filter and file upload event listeners
    function initializeFilter() {
      const startWeekSelect = document.getElementById('start-week');
      const endWeekSelect = document.getElementById('end-week');
      const applyFilterButton = document.getElementById('apply-filter');
      const resetFilterButton = document.getElementById('reset-filter');
      const refreshButton = document.getElementById('refresh-button');
      const fileInput = document.getElementById('csv-file-input');
      const fileImportArea = document.getElementById('file-import-area');
      const fileSelectButton = document.getElementById('file-select-button');
      
      // Apply filter button
      applyFilterButton.addEventListener('click', () => {
        const startWeek = startWeekSelect.value;
        const endWeek = endWeekSelect.value;
        
        if (!validateWeekSelection(startWeek, endWeek)) {
          alert('Invalid selection: Start week must be before or equal to end week');
          return;
        }
        
        activeStartWeek = startWeek;
        activeEndWeek = endWeek;
        
        filteredEmployeesData = filterDataByWeekRange(employeesData, startWeek, endWeek);
        updateAllEmployeeCharts();
      });
      
      // Reset filter button
      resetFilterButton.addEventListener('click', () => {
        startWeekSelect.value = 'all';
        endWeekSelect.value = 'all';
        
        activeStartWeek = 'all';
        activeEndWeek = 'all';
        
        filteredEmployeesData = [...employeesData];
        updateAllEmployeeCharts();
      });
      
      // Refresh button
      refreshButton.addEventListener('click', async () => {
        // Fetch fresh data
        const newData = await fetchEmployeeData();
        
        if (newData.length > 0) {
          employeesData = newData;
          
          // Update filtered data based on current filter settings
          filteredEmployeesData = filterDataByWeekRange(employeesData, activeStartWeek, activeEndWeek);
          
          // Update all charts
          updateAllEmployeeCharts();
        }
      });
      
      // File select button
      fileSelectButton.addEventListener('click', () => {
        fileInput.click();
      });
      
      // File input change
      fileInput.addEventListener('change', (event) => {
        if (event.target.files.length > 0) {
          handleFileUpload(event.target.files[0]);
        }
      });
      
      // Drag and drop for file import area
      fileImportArea.addEventListener('dragover', (event) => {
        event.preventDefault();
        fileImportArea.classList.add('active');
      });
      
      fileImportArea.addEventListener('dragleave', () => {
        fileImportArea.classList.remove('active');
      });
      
      fileImportArea.addEventListener('drop', (event) => {
        event.preventDefault();
        fileImportArea.classList.remove('active');
        
        if (event.dataTransfer.files.length > 0) {
          handleFileUpload(event.dataTransfer.files[0]);
        }
      });
    }
    
    // Function to get task categories (excluding metadata columns)
    const getTaskCategories = (data) => {
      return Object.keys(data[0]).filter(key => 
        !['Date', 'User', 'Week Range'].includes(key)
      );
    };
    
    // Function to calculate total hours per category
    const calculateTotalsByCategory = (employeeData, taskCategories) => {
      const totalsByCategory = {};
      taskCategories.forEach(category => {
        totalsByCategory[category] = employeeData.reduce((sum, row) => {
          return sum + (row[category] || 0);
        }, 0);
      });
      return totalsByCategory;
    };
    
    // Function to calculate totals by type
    const calculateTotalsByType = (totalsByCategory) => {
      const totalsByType = {};
      Object.entries(categoriesByType).forEach(([type, categories]) => {
        totalsByType[type] = categories.reduce((sum, category) => {
          return sum + (totalsByCategory[category] || 0);
        }, 0);
      });
      return totalsByType;
    };
    
    // Function to create detailed breakdown
    const createDetailedBreakdown = (totalsByCategory) => {
      const detailedBreakdown = [];
      Object.entries(totalsByCategory).forEach(([category, hours]) => {
        if (hours > 0) {
          // Find which type this category belongs to
          let categoryType = '';
          Object.entries(categoriesByType).forEach(([type, categories]) => {
            if (categories.includes(category)) {
              categoryType = type;
            }
          });
          
          detailedBreakdown.push({
            name: category,
            hours: hours,
            type: categoryType
          });
        }
      });
      // Sort by hours in descending order
      return detailedBreakdown.sort((a, b) => b.hours - a.hours);
    };
    
    // Function to prepare pie chart data
    const preparePieData = (totalsByType) => {
      const totalHours = Object.values(totalsByType).reduce((sum, hours) => sum + hours, 0);
      return Object.entries(totalsByType)
        .filter(([_, hours]) => hours > 0)
        .map(([type, hours]) => ({
          name: type,
          value: hours,
          percentage: ((hours / totalHours) * 100).toFixed(1)
        }));
    };
    
    // Function to create color mapping for consistent colors
    const createColorMapping = () => {
      const typeColorMap = {};
      Object.keys(categoriesByType).forEach((type, index) => {
        typeColorMap[type] = index % COLORS.length;
      });
      return typeColorMap;
    };
    
    // Function to update employee summary statistics
    function updateEmployeeSummary(employeeName, totalsByCategory, detailedBreakdown) {
      // Get the correct hourly rate for this employee
      const hourlyRate = getHourlyRate(employeeName);
      
      const totalHoursElement = document.getElementById(`${employeeName}-total-hours`);
      const totalHoursSubtitleElement = document.getElementById(`${employeeName}-total-hours-subtitle`);
      const totalCostElement = document.getElementById(`${employeeName}-total-cost`);
      
      const mostTimeActivityElement = document.getElementById(`${employeeName}-most-time-activity`);
      const mostTimeHoursElement = document.getElementById(`${employeeName}-most-time-hours`);
      const mostTimeCostElement = document.getElementById(`${employeeName}-most-time-cost`);
      
      const weeklyAverageElement = document.getElementById(`${employeeName}-weekly-average`);
      const weeklyAverageSubtitleElement = document.getElementById(`${employeeName}-weekly-average-subtitle`);
      const weeklyAverageCostElement = document.getElementById(`${employeeName}-weekly-average-cost`);
      
      // Calculate total hours
      const totalHours = Object.values(totalsByCategory).reduce((sum, hours) => sum + hours, 0);
      
      // Find most time-consuming activity
      let mostTimeActivity = "None";
      let mostTimeHours = 0;
      let mostTimePercentage = 0;
      
      if (detailedBreakdown.length > 0) {
        const topActivity = detailedBreakdown[0];
        mostTimeActivity = topActivity.name;
        mostTimeHours = topActivity.hours;
        mostTimePercentage = ((mostTimeHours / totalHours) * 100).toFixed(1);
      }
      
      // Calculate weekly average
      const employeeData = filteredEmployeesData.filter(row => row.User.includes(employeeName));
      const uniqueWeeks = [...new Set(employeeData.map(row => row['Week Range']))];
      const weeklyAverage = (totalHours / uniqueWeeks.length).toFixed(1);
      
      // Update the elements if they exist
      if (totalHoursElement) {
        totalHoursElement.textContent = totalHours.toFixed(1);
      }
      
      if (totalHoursSubtitleElement) {
        totalHoursSubtitleElement.textContent = `Hours tracked across ${uniqueWeeks.length} week${uniqueWeeks.length !== 1 ? 's' : ''}`;
      }
      
      if (totalCostElement) {
        totalCostElement.textContent = `$${(totalHours * hourlyRate).toFixed(2)} total compensation`;
      }
      
      if (mostTimeActivityElement) {
        mostTimeActivityElement.textContent = mostTimeActivity;
      }
      
      if (mostTimeHoursElement) {
        mostTimeHoursElement.textContent = `${mostTimeHours.toFixed(1)} hours (${mostTimePercentage}%)`;
      }
      
      if (mostTimeCostElement) {
        mostTimeCostElement.textContent = `$${(mostTimeHours * hourlyRate).toFixed(2)} spent on this activity`;
      }
      
      if (weeklyAverageElement) {
        weeklyAverageElement.textContent = weeklyAverage;
      }
      
      if (weeklyAverageSubtitleElement) {
        weeklyAverageSubtitleElement.textContent = 'Hours per week';
      }
      
      if (weeklyAverageCostElement) {
        weeklyAverageCostElement.textContent = `$${(weeklyAverage * hourlyRate).toFixed(2)} weekly compensation`;
      }
    }
    
    // Function to display no data message
    function displayNoDataMessage(employeeName) {
      const dashboard = document.getElementById(`${employeeName}-dashboard`);
      
      // Clear existing charts
      if (charts[employeeName].pieChart) {
        charts[employeeName].pieChart.destroy();
        charts[employeeName].pieChart = null;
      }
      
      if (charts[employeeName].barChart) {
        charts[employeeName].barChart.destroy();
        charts[employeeName].barChart = null;
      }
      
      if (charts[employeeName].timeLineChart) {
        charts[employeeName].timeLineChart.destroy();
        charts[employeeName].timeLineChart = null;
      }
      
      if (employeeName === 'all' && charts[employeeName].comparisonChart) {
        charts[employeeName].comparisonChart.destroy();
        charts[employeeName].comparisonChart = null;
      }
      
      // Display no data message
      const noDataMessage = document.createElement('div');
      noDataMessage.className = 'employee-notice';
      noDataMessage.textContent = `No data available for ${employeeName === 'all' ? 'any employees' : employeeName} in the selected date range.`;
      
      // Clear and append
      const chartsGrids = dashboard.querySelectorAll('.charts-grid');
      chartsGrids.forEach(grid => {
        grid.innerHTML = '';
        grid.appendChild(noDataMessage.cloneNode(true));
      });
      
      // Clear summary stats
      const statValues = dashboard.querySelectorAll('.stat-value');
      statValues.forEach(value => {
        value.textContent = 'N/A';
      });
      
      const statSubtitles = dashboard.querySelectorAll('.stat-subtitle');
      statSubtitles.forEach(subtitle => {
        subtitle.textContent = 'No data available';
      });
      
      const costTexts = dashboard.querySelectorAll('.cost-text');
      costTexts.forEach(cost => {
        cost.textContent = '$0.00';
      });
    }
    
    // Function to initialize charts for an employee
    const initializeEmployeeCharts = (employeeName) => {
      if (employeesData.length === 0) {
        displayNoDataMessage(employeeName);
        return;
      }
      
      const taskCategories = getTaskCategories(employeesData);
      
      // Get data for this employee
      const employeeData = filteredEmployeesData.filter(row => {
        const email = row.User.toLowerCase();
        return email.includes(employeeName.toLowerCase());
      });
      
      // If no data after filtering, show a message
      if (employeeData.length === 0) {
        displayNoDataMessage(employeeName);
        return;
      }
      
      const totalsByCategory = calculateTotalsByCategory(employeeData, taskCategories);
      const totalsByType = calculateTotalsByType(totalsByCategory);
      const detailedBreakdown = createDetailedBreakdown(totalsByCategory);
      const pieData = preparePieData(totalsByType);
      const typeColorMap = createColorMapping();
      
      // Update summary statistics
      updateEmployeeSummary(employeeName, totalsByCategory, detailedBreakdown);
      
      // Initialize pie chart
      const pieCanvas = document.getElementById(`${employeeName}-pieChart`);
      if (pieCanvas) {
        if (charts[employeeName].pieChart) {
          charts[employeeName].pieChart.destroy();
        }
        
        const pieCtx = pieCanvas.getContext('2d');
        charts[employeeName].pieChart = new Chart(pieCtx, {
          type: 'pie',
          data: {
            labels: pieData.map(item => `${item.name}: ${item.percentage}%`),
            datasets: [{
              data: pieData.map(item => item.value),
              backgroundColor: pieData.map(item => COLORS[typeColorMap[item.name]]),
              borderColor: pieData.map(item => BORDER_COLORS[typeColorMap[item.name]]),
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.raw || 0;
                    const hourlyRate = getHourlyRate(employeeName);
                    const cost = (value * hourlyRate).toFixed(2);
                    return [`Hours: ${value.toFixed(1)}`, `Cost: $${cost}`];
                  }
                }
              },
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }
      
      // Initialize bar chart
      const barCanvas = document.getElementById(`${employeeName}-barChart`);
      if (barCanvas) {
        if (charts[employeeName].barChart) {
          charts[employeeName].barChart.destroy();
        }
        
        const barCtx = barCanvas.getContext('2d');
        charts[employeeName].barChart = new Chart(barCtx, {
          type: 'bar',
          data: {
            labels: detailedBreakdown.map(item => item.name),
            datasets: [{
              label: 'Hours',
              data: detailedBreakdown.map(item => item.hours),
              backgroundColor: detailedBreakdown.map(item => COLORS[typeColorMap[item.type]]),
              borderColor: detailedBreakdown.map(item => BORDER_COLORS[typeColorMap[item.type]]),
              borderWidth: 1
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.raw || 0;
                    const hourlyRate = getHourlyRate(employeeName);
                    const cost = (value * hourlyRate).toFixed(2);
                    return [`Hours: ${value.toFixed(1)}`, `Cost: $${cost}`];
                  }
                }
              },
              legend: {
                display: false
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Hours'
                }
              }
            }
          }
        });
      }
      
      // Initialize time line chart if available
      const timeCanvas = document.getElementById(`${employeeName}-timeLineChart`);
      const timeChartContainer = document.getElementById(`${employeeName}-timeLineChart-container`);
      const noDataMessage = document.getElementById(`${employeeName}-no-trend-data`);
      
      if (timeCanvas) {
        // Check if we have multiple weeks of data
        const uniqueWeeks = [...new Set(employeeData.map(row => row['Week Range']))];
        
        if (uniqueWeeks.length > 1) {
          if (noDataMessage) {
            noDataMessage.style.display = 'none';
          }
          
          if (timeChartContainer) {
            timeChartContainer.style.display = 'block';
          }
          
          if (charts[employeeName].timeLineChart) {
            charts[employeeName].timeLineChart.destroy();
          }
          
          const timeCtx = timeCanvas.getContext('2d');
          
          // Get weeks in chronological order
          const weeks = [...new Set(employeeData.map(row => row['Week Range']))].sort((a, b) => {
            return parseInt(a.replace('2025W', '')) - parseInt(b.replace('2025W', ''));
          });
          
          // Get top 3 activities
          const topActivities = detailedBreakdown.slice(0, 3);
          
          // Prepare data for each week
          const weeklyDataMap = {};
          employeeData.forEach(row => {
            const week = row['Week Range'];
            if (!weeklyDataMap[week]) {
              weeklyDataMap[week] = {
                totalHours: 0
              };
              
              // Initialize all top activities
              topActivities.forEach(activity => {
                weeklyDataMap[week][activity.name] = 0;
              });
            }
            
            // Add hours for each activity
            topActivities.forEach(activity => {
              weeklyDataMap[week][activity.name] += (row[activity.name] || 0);
              weeklyDataMap[week].totalHours += (row[activity.name] || 0);
            });
            
            // Add other hours
            Object.keys(row).forEach(key => {
              if (!['Date', 'User', 'Week Range'].includes(key) && 
                  !topActivities.some(a => a.name === key)) {
                weeklyDataMap[week].totalHours += (row[key] || 0);
              }
            });
          });
          
          // Convert to array format for chart
          const weeklyData = weeks.map(week => ({
            week,
            ...weeklyDataMap[week]
          }));
          
          // Create datasets
          const datasets = topActivities.map(activity => ({
            label: activity.name,
            data: weeklyData.map(week => week[activity.name] || 0),
            borderColor: BORDER_COLORS[typeColorMap[activity.type]],
            backgroundColor: COLORS[typeColorMap[activity.type]],
            tension: 0.1
          }));
          
          // Add total hours dataset
          datasets.push({
            label: 'Total Hours',
            data: weeklyData.map(week => week.totalHours),
            borderColor: '#FF5733',
            backgroundColor: 'rgba(255, 87, 51, 0.8)',
            borderWidth: 2,
            tension: 0.1
          });
          
          charts[employeeName].timeLineChart = new Chart(timeCtx, {
            type: 'line',
            data: {
              labels: weeks,
              datasets: datasets
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const label = context.dataset.label || '';
                      const value = context.raw || 0;
                      const hourlyRate = getHourlyRate(employeeName);
                      const cost = (value * hourlyRate).toFixed(2);
                      return [`${label}: ${value.toFixed(1)} hours`, `Cost: $${cost}`];
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'Hours'
                  }
                }
              }
            }
          });
        } else {
          if (charts[employeeName].timeLineChart) {
            charts[employeeName].timeLineChart.destroy();
            charts[employeeName].timeLineChart = null;
          }
          
          if (timeChartContainer) {
            timeChartContainer.style.display = 'none';
          }
          
          if (noDataMessage) {
            noDataMessage.style.display = 'block';
            if (uniqueWeeks.length === 1) {
              noDataMessage.textContent = `Weekly trend data not available - ${employeeName} only has data for one week (${uniqueWeeks[0]})`;
            } else {
              noDataMessage.textContent = `No data available for the selected date range.`;
            }
          }
        }
      }
    };
    
    // Function to initialize the "All Employees" dashboard
    function initializeTeamDashboard() {
      if (filteredEmployeesData.length === 0) {
        displayNoDataMessage('all');
        return;
      }
      
      const taskCategories = getTaskCategories(employeesData);
      
      // Calculate totals across all employees
      const totalsByCategory = calculateTotalsByCategory(filteredEmployeesData, taskCategories);
      const totalsByType = calculateTotalsByType(totalsByCategory);
      const detailedBreakdown = createDetailedBreakdown(totalsByCategory);
      const pieData = preparePieData(totalsByType);
      const typeColorMap = createColorMapping();
      
      // Calculate employee-specific totals for comparison
      const employeeNames = ['victoria', 'kyle', 'brooke', 'melanie'];
      const employeeTotals = {};
      const employeeColors = {
        victoria: '#FF6384', // Pink
        kyle: '#36A2EB',     // Blue
        brooke: '#FFCE56',   // Yellow
        melanie: '#4BC0C0'   // Teal
      };
      
      employeeNames.forEach(name => {
        const employeeData = filteredEmployeesData.filter(row => {
          const email = row.User.toLowerCase();
          return email.includes(name.toLowerCase());
        });
        
        if (employeeData.length > 0) {
          // Get employee-specific hourly rate
          const hourlyRate = getHourlyRate(name);
          
          // Calculate total hours
          const employeeTotalsByCategory = calculateTotalsByCategory(employeeData, taskCategories);
          const totalHours = Object.values(employeeTotalsByCategory).reduce((sum, hours) => sum + hours, 0);
          
          // Store for comparison chart
          employeeTotals[name] = {
            totalHours,
            hourlyRate,
            totalCost: totalHours * hourlyRate,
            // Also store time by category type for the comparison chart
            byType: {}
          };
          
          // Calculate by type
          const employeeTotalsByType = calculateTotalsByType(employeeTotalsByCategory);
          Object.entries(employeeTotalsByType).forEach(([type, hours]) => {
            employeeTotals[name].byType[type] = hours;
          });
        }
      });
      
      // Calculate total team hours and cost
      const totalTeamHours = Object.values(employeeTotals).reduce((sum, employee) => sum + employee.totalHours, 0);
      const totalTeamCost = Object.values(employeeTotals).reduce((sum, employee) => sum + employee.totalCost, 0);
      
      // Update summary statistics
      updateTeamSummary(totalsByCategory, detailedBreakdown, employeeTotals, totalTeamHours, totalTeamCost);
      
      // Create the pie chart
      const pieCanvas = document.getElementById('all-pieChart');
      if (pieCanvas) {
        if (charts.all.pieChart) {
          charts.all.pieChart.destroy();
        }
        
        const pieCtx = pieCanvas.getContext('2d');
        charts.all.pieChart = new Chart(pieCtx, {
          type: 'pie',
          data: {
            labels: pieData.map(item => `${item.name}: ${item.percentage}%`),
            datasets: [{
              data: pieData.map(item => item.value),
              backgroundColor: pieData.map(item => COLORS[typeColorMap[item.name]]),
              borderColor: pieData.map(item => BORDER_COLORS[typeColorMap[item.name]]),
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.raw || 0;
                    const cost = (value * getHourlyRate('default')).toFixed(2); // Use average rate for team view
                    return [`Hours: ${value.toFixed(1)}`, `Cost: $${cost}`];
                  }
                }
              },
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }
      
      // Create the bar chart
      const barCanvas = document.getElementById('all-barChart');
      if (barCanvas) {
        if (charts.all.barChart) {
          charts.all.barChart.destroy();
        }
        
        const barCtx = barCanvas.getContext('2d');
        charts.all.barChart = new Chart(barCtx, {
          type: 'bar',
          data: {
            labels: detailedBreakdown.slice(0, 8).map(item => item.name), // Show top 8 for readability
            datasets: [{
              label: 'Hours',
              data: detailedBreakdown.slice(0, 8).map(item => item.hours),
              backgroundColor: detailedBreakdown.slice(0, 8).map(item => COLORS[typeColorMap[item.type]]),
              borderColor: detailedBreakdown.slice(0, 8).map(item => BORDER_COLORS[typeColorMap[item.type]]),
              borderWidth: 1
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.raw || 0;
                    const averageRate = Object.values(EMPLOYEE_HOURLY_RATES).reduce((sum, rate) => sum + rate, 0) / 
                                       Object.values(EMPLOYEE_HOURLY_RATES).length;
                    const cost = (value * averageRate).toFixed(2);
                    return [`Hours: ${value.toFixed(1)}`, `Approx. Cost: $${cost}`];
                  }
                }
              },
              legend: {
                display: false
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Hours'
                }
              }
            }
          }
        });
      }
      
      // Create employee comparison chart
      const comparisonCanvas = document.getElementById('team-comparisonChart');
      if (comparisonCanvas && Object.keys(employeeTotals).length > 0) {
        if (charts.all.comparisonChart) {
          charts.all.comparisonChart.destroy();
        }
        
        const comparisonCtx = comparisonCanvas.getContext('2d');
        
        // Prepare data for comparison chart - this will be a stacked bar chart
        // showing time allocation by category type for each employee
        const comparisonData = {
          labels: employeeNames.filter(name => employeeTotals[name]),
          datasets: []
        };
        
        // Get all the types used by any employee
        const allTypes = new Set();
        Object.values(employeeTotals).forEach(employee => {
          Object.keys(employee.byType).forEach(type => allTypes.add(type));
        });
        
        // Create a dataset for each type
        Array.from(allTypes).forEach((type, index) => {
          comparisonData.datasets.push({
            label: type,
            data: comparisonData.labels.map(name => employeeTotals[name].byType[type] || 0),
            backgroundColor: COLORS[index % COLORS.length],
            borderColor: BORDER_COLORS[index % BORDER_COLORS.length],
            borderWidth: 1
          });
        });
        
        charts.all.comparisonChart = new Chart(comparisonCtx, {
          type: 'bar',
          data: comparisonData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                stacked: true,
              },
              y: {
                stacked: true,
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Hours'
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const datasetLabel = context.dataset.label || '';
                    const value = context.raw || 0;
                    const employeeName = context.label;
                    const rate = getHourlyRate(employeeName);
                    const cost = (value * rate).toFixed(2);
                    return [`${datasetLabel}: ${value.toFixed(1)} hours`, `Cost: $${cost}`];
                  }
                }
              }
            }
          }
        });
      }
      
      // Create team weekly trend chart
      const timeCanvas = document.getElementById('all-timeLineChart');
      const timeChartContainer = document.getElementById('all-timeLineChart-container');
      const noDataMessage = document.getElementById('all-no-trend-data');
      
      if (timeCanvas) {
        // Get all unique weeks
        const uniqueWeeks = [...new Set(filteredEmployeesData.map(row => row['Week Range']))];
        
        if (uniqueWeeks.length > 1) {
          if (noDataMessage) {
            noDataMessage.style.display = 'none';
          }
          
          if (timeChartContainer) {
            timeChartContainer.style.display = 'block';
          }
          
          if (charts.all.timeLineChart) {
            charts.all.timeLineChart.destroy();
          }
          
          const timeCtx = timeCanvas.getContext('2d');
          
          // Get weeks in chronological order
          const weeks = [...uniqueWeeks].sort((a, b) => {
            return parseInt(a.replace(/\D+/g, '')) - parseInt(b.replace(/\D+/g, ''));
          });
          
          // Prepare weekly totals for each employee and for the team
          const weeklyData = [];
          weeks.forEach(week => {
            const weekData = {
              week,
              totalHours: 0,
              totalCost: 0,
              byEmployee: {}
            };
            
            // Fill data by employee
            employeeNames.forEach(name => {
              const employeeWeekData = filteredEmployeesData.filter(row => 
                row['Week Range'] === week && row.User.toLowerCase().includes(name)
              );
              
              if (employeeWeekData.length > 0) {
                const employeeWeekTotalsByCategory = calculateTotalsByCategory(employeeWeekData, taskCategories);
                const employeeWeekHours = Object.values(employeeWeekTotalsByCategory).reduce((sum, hours) => sum + hours, 0);
                const employeeRate = getHourlyRate(name);
                const employeeWeekCost = employeeWeekHours * employeeRate;
                
                weekData.byEmployee[name] = {
                  hours: employeeWeekHours,
                  cost: employeeWeekCost
                };
                
                weekData.totalHours += employeeWeekHours;
                weekData.totalCost += employeeWeekCost;
              } else {
                weekData.byEmployee[name] = { hours: 0, cost: 0 };
              }
            });
            
            weeklyData.push(weekData);
          });
          
          // Create datasets for the line chart
          const datasets = [];
          
          // Add a line for each employee
          employeeNames.forEach(name => {
            // Only add employees with data
            if (employeeNames.some(n => weeklyData.some(w => w.byEmployee[n] && w.byEmployee[n].hours > 0))) {
              datasets.push({
                label: name.charAt(0).toUpperCase() + name.slice(1),
                data: weeklyData.map(week => week.byEmployee[name]?.hours || 0),
                borderColor: employeeColors[name],
                backgroundColor: employeeColors[name] + '33', // Adding transparency
                borderWidth: 2,
                tension: 0.1
              });
            }
          });
          
          // Add total team hours line
          datasets.push({
            label: 'Total Team Hours',
            data: weeklyData.map(week => week.totalHours),
            borderColor: '#FF5733',
            backgroundColor: 'rgba(255, 87, 51, 0.1)',
            borderWidth: 3,
            tension: 0.1
          });
          
          charts.all.timeLineChart = new Chart(timeCtx, {
            type: 'line',
            data: {
              labels: weeks.map(week => {
                // Format the week label more nicely
                if (week.includes('W')) {
                  return `Week ${week.replace(/\D+/g, '')}`;
                }
                return week;
              }),
              datasets: datasets
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const label = context.dataset.label || '';
                      const value = context.raw || 0;
                      if (label === 'Total Team Hours') {
                        const weekIndex = context.dataIndex;
                        const cost = weeklyData[weekIndex].totalCost.toFixed(2);
                        return [`${label}: ${value.toFixed(1)} hours`, `Cost: $${cost}`];
                      } else {
                        const employeeName = label.toLowerCase();
                        const rate = getHourlyRate(employeeName);
                        const cost = (value * rate).toFixed(2);
                        return [`${label}: ${value.toFixed(1)} hours`, `Cost: $${cost}`];
                      }
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'Hours'
                  }
                }
              }
            }
          });
        } else {
          if (charts.all.timeLineChart) {
            charts.all.timeLineChart.destroy();
            charts.all.timeLineChart = null;
          }
          
          if (timeChartContainer) {
            timeChartContainer.style.display = 'none';
          }
          
          if (noDataMessage) {
            noDataMessage.style.display = 'block';
            if (uniqueWeeks.length === 1) {
              noDataMessage.textContent = `Weekly trend data not available - only data for one week (${uniqueWeeks[0]})`;
            } else {
              noDataMessage.textContent = `No data available for the selected date range.`;
            }
          }
        }
      }
    }

    // Function to update team summary statistics
    function updateTeamSummary(totalsByCategory, detailedBreakdown, employeeTotals, totalTeamHours, totalTeamCost) {
      const totalHoursElement = document.getElementById('all-total-hours');
      const totalHoursSubtitleElement = document.getElementById('all-total-hours-subtitle');
      const totalCostElement = document.getElementById('all-total-cost');
      
      const mostTimeActivityElement = document.getElementById('all-most-time-activity');
      const mostTimeHoursElement = document.getElementById('all-most-time-hours');
      const mostTimeCostElement = document.getElementById('all-most-time-cost');
      
      const weeklyAverageElement = document.getElementById('all-weekly-average');
      const weeklyAverageSubtitleElement = document.getElementById('all-weekly-average-subtitle');
      const weeklyAverageCostElement = document.getElementById('all-weekly-average-cost');
      
      // Calculate most time-consuming activity
      let mostTimeActivity = "None";
      let mostTimeHours = 0;
      let mostTimePercentage = 0;
      
      if (detailedBreakdown.length > 0) {
        const topActivity = detailedBreakdown[0];
        mostTimeActivity = topActivity.name;
        mostTimeHours = topActivity.hours;
        mostTimePercentage = ((mostTimeHours / totalTeamHours) * 100).toFixed(1);
      }
      
      // Calculate weekly average across the team
      const uniqueWeeks = [...new Set(filteredEmployeesData.map(row => row['Week Range']))];
      const teamWeeklyAverage = (totalTeamHours / uniqueWeeks.length).toFixed(1);
      
      // Find the average hourly rate for the team
      const activeEmployees = Object.keys(employeeTotals);
      const avgHourlyRate = activeEmployees.length > 0 ? 
        totalTeamCost / totalTeamHours : 
        Object.values(EMPLOYEE_HOURLY_RATES).reduce((sum, rate) => sum + rate, 0) / 
        Object.values(EMPLOYEE_HOURLY_RATES).length;
      
      // Update the elements
      if (totalHoursElement) {
        totalHoursElement.textContent = totalTeamHours.toFixed(1);
      }
      
      if (totalHoursSubtitleElement) {
        totalHoursSubtitleElement.textContent = `Team hours across ${uniqueWeeks.length} week${uniqueWeeks.length !== 1 ? 's' : ''}`;
      }
      
      if (totalCostElement) {
        totalCostElement.textContent = `$${totalTeamCost.toFixed(2)} total compensation`;
      }
      
      if (mostTimeActivityElement) {
        mostTimeActivityElement.textContent = mostTimeActivity;
      }
      
      if (mostTimeHoursElement) {
        mostTimeHoursElement.textContent = `${mostTimeHours.toFixed(1)} hours (${mostTimePercentage}%)`;
      }
      
      if (mostTimeCostElement) {
        // Calculate cost specifically for most time activity using average rate
        mostTimeCostElement.textContent = `$${(mostTimeHours * avgHourlyRate).toFixed(2)} spent on this activity`;
      }
      
      if (weeklyAverageElement) {
        weeklyAverageElement.textContent = teamWeeklyAverage;
      }
      
      if (weeklyAverageSubtitleElement) {
        weeklyAverageSubtitleElement.textContent = 'Team hours per week';
      }
      
      if (weeklyAverageCostElement) {
        weeklyAverageCostElement.textContent = `$${(teamWeeklyAverage * avgHourlyRate).toFixed(2)} weekly team cost`;
      }
    }
    
    // Initialize the dashboard
    document.addEventListener('DOMContentLoaded', async function() {
      // Set up tab functionality
      const tabs = document.querySelectorAll('.tab');
      const dashboards = document.querySelectorAll('.employee-dashboard');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Update active tab
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          // Show corresponding dashboard
          const employeeName = tab.getAttribute('data-employee');
          dashboards.forEach(dashboard => {
            dashboard.classList.remove('active');
          });
          document.getElementById(`${employeeName}-dashboard`).classList.add('active');
        });
      });
      
      // Initialize filter functionality and file upload
      initializeFilter();
      
      // Try to fetch data from Google Sheets
      employeesData = await fetchEmployeeData();
      
      // If we have data, initialize the dashboard
      if (employeesData.length > 0) {
        filteredEmployeesData = [...employeesData];
        updateAllEmployeeCharts();
      } else {
        // If fetching failed, keep the loading message visible
        // User will need to upload a CSV file
      }
    });
  </script>
</body>
</html>
